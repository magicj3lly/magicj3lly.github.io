<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Renuka  Kumar | Security Analysis of UPI</title>
<meta name="description" content="magicj3lly's personal website
">

<!-- Open Graph -->


<!-- Bootstrap & MDB -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" integrity="sha512-RO38pBRxYH3SoOprtPTD86JFOclM51/XTIdEPh5j8sj4tp8jmQIx26twG52UaLi//hQldfrh7e51WzP9wuP32Q==" crossorigin="anonymous" />

<!-- Fonts & Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"  integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.0/css/academicons.min.css" integrity="sha512-W4yqoT1+8NLkinBLBZko+dFB2ZbHsYLDdr50VElllRcNt2Q4/GSs6u71UHKxB7S6JEMCp5Ve4xjh3eGQl/HRvg==" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

<!-- Code Syntax Highlighting -->
<link rel="stylesheet" href="https://gitcdn.xyz/repo/jwarby/jekyll-pygments-themes/master/github.css" />

<!-- Styles -->

<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🔥</text></svg>">

<link rel="stylesheet" href="/assets/css/main.css">
<link rel="canonical" href="/projects/2_project/">

<!-- JQuery -->
<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>


<!-- Theming-->

<script src="/assets/js/theme.js"></script>
<script src="/assets/js/dark_mode.js"></script>






    
<!-- MathJax -->
<script type="text/javascript">
  window.MathJax = {
    tex: {
      tags: 'ams'
    }
  };
</script>
<script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js"></script>
<script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>


  </head>

  <body class="fixed-top-nav ">

    <!-- Header -->

    <header>

    <!-- Nav Bar -->
    <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
    <div class="container">
      
      <a class="navbar-brand title font-weight-lighter" href="/">
       <span class="font-weight-bold">Renuka</span>   Kumar
      </a>
      
      <!-- Navbar Toggle -->
      <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar top-bar"></span>
        <span class="icon-bar middle-bar"></span>
        <span class="icon-bar bottom-bar"></span>
      </button>
      <div class="collapse navbar-collapse text-right" id="navbarNav">
        <ul class="navbar-nav ml-auto flex-nowrap">
          <!-- About -->
          <li class="nav-item ">
            <a class="nav-link" href="/">
              about
              
            </a>
          </li>
          
          <!-- Blog -->
          <li class="nav-item ">
            <a class="nav-link" href="/blog/">
              blog
              
            </a>
          </li>
          
          <!-- Other pages -->
          
          
          
          
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/projects/">
                projects
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/publications/">
                publications
                
              </a>
          </li>
          
          
          
            <div class = "toggle-container">
              <a id = "light-toggle">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
              </a>
            </div>
          
        </ul>
      </div>
    </div>
  </nav>

</header>


    <!-- Content -->

    <div class="container mt-5">
      <div class="post">

  <header class="post-header">
    <h1 class="post-title">Security Analysis of UPI</h1>
    <p class="post-description">security analysis of India's new mobile payments infrastructure</p>
  </header>

  <article>
    <p><em>Renuka Kumar, Sreesh K., Hao Lu, Atul Prakash</em></p>

<p>Since 2016, with a strong push from the Government of India, smartphone-based payment apps have become mainstream, with billions of dollars transacted through these apps. Many of these apps use a common infrastructure introduced by the Indian government, called the Unified Payments Interface (UPI), that facilitates instant and free bank-to-bank  micropayments at scale.  In this research we conduct a detailed security analysis of the UPI protocol, an unpublished application layer protocol, by reverse-engineering its design through seven popular UPI apps that have a combined market share of about 90%. We discover previously-unreported multi-factor authentication design-level flaws in the UPI 1.0 specification that can lead to significant attacks when combined with an installed attacker-controlled application. In an extreme version of the attack, the flaws could allow a victim’s bank account to be linked and emptied, even if a victim had never used a UPI app. The potential attacks were scalable and could be done remotely. This work resulted in several CVEs, and the National Payments Corporation of India addressed a key attack vector that we reported in UPI 2.0.</p>

<p>Find full <strong><em><a href="https://www.usenix.org/system/files/sec20summer_kumar_prepub.pdf">paper</a> and <a href="https://www.youtube.com/watch?v=jiFYLJKEp8E">talk</a></em></strong></p>

<h3 id="objectives-and-approach">Objectives and Approach</h3>

<p>A key challeng in analyzing UPI 1.0 is that the protocol details are not available, though millions of users in India use it. We also did not have access to the UPI servers. We thus had to reverse-engineer the UPI protocol through the UPI apps that used it and had to bypass various security defenses of each app, including code obfuscation and anti-emulation techniques. Thus, our approach to extract the protocol details varies based on the defenses the apps use. We aimed to do the following:</p>

<ol>
  <li>Uncover the client-server handshake step-by-step</li>
  <li>Collect from each step credentials required and any leaked user-specific attributes</li>
  <li>Find alternate workflows that can be exploited</li>
  <li>Triage the findings to determine plausible attack vectors</li>
</ol>

<p><strong><em>Setup:</em></strong> To extract UPI protocol, we use India’s flagship app, BHIM, which was released along with UPI as the references implementation of a mobile payments app that used UPI. We instrument and repackage BHIM to extract the client-server handshake between the app and the UPI server, and to map the GUI of the app that generates the traffic. Once the details have been extracted, we confirm our findings on other popular apps. The set of all apps we studied is shown below. We study the Android versions of these apps. We re-examined our findings when UPI 2.0 was released. Amazon Pay was not available on Play Store at the time of this study.</p>

<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;}
.tg td{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
  overflow:hidden;padding:10px 5px;word-break:normal;}
.tg th{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
  font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}
.tg .tg-0lax{text-align:left;vertical-align:top}
</style>

<table class="tg">
<thead>
  <tr>
    <th class="tg-0lax">App Name</th>
    <th class="tg-0lax">Launched</th>
    <th class="tg-0lax">Versions</th>
    <th class="tg-0lax">Installs</th>
    <th class="tg-0lax">Rating</th>
    <th class="tg-0lax">UPI Version</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td class="tg-0lax">BHIM</td>
    <td class="tg-0lax">Dec, 2016</td>
    <td class="tg-0lax">1.3, 1.4, 1.5</td>
    <td class="tg-0lax">10M+</td>
    <td class="tg-0lax">4.1</td>
    <td class="tg-0lax">1.0</td>
  </tr>
  <tr>
    <td class="tg-0lax">Ola Money</td>
    <td class="tg-0lax">Nov, 2015</td>
    <td class="tg-0lax">1.8.1, 1.8.2, 1.9.0</td>
    <td class="tg-0lax">1M+</td>
    <td class="tg-0lax">3.8</td>
    <td class="tg-0lax">1.0</td>
  </tr>
  <tr>
    <td class="tg-0lax">Phonepe</td>
    <td class="tg-0lax">Dec, 2015</td>
    <td class="tg-0lax">3.0.6, 3.3.23</td>
    <td class="tg-0lax">100M+</td>
    <td class="tg-0lax">4.5</td>
    <td class="tg-0lax">1.0</td>
  </tr>
  <tr>
    <td class="tg-0lax">SamsungPay</td>
    <td class="tg-0lax">Aug, 2016</td>
    <td class="tg-0lax">2.8.49, 2.9.3</td>
    <td class="tg-0lax">50M+</td>
    <td class="tg-0lax">4.7</td>
    <td class="tg-0lax">1.0</td>
  </tr>
  <tr>
    <td class="tg-0lax">Paytm</td>
    <td class="tg-0lax">Aug, 2010</td>
    <td class="tg-0lax">8.2.12</td>
    <td class="tg-0lax">100M+</td>
    <td class="tg-0lax">4.4</td>
    <td class="tg-0lax">2.0</td>
  </tr>
  <tr>
    <td class="tg-0lax">Google Pay (Tez)</td>
    <td class="tg-0lax">Sept, 2017</td>
    <td class="tg-0lax">39.0.001</td>
    <td class="tg-0lax">100M+</td>
    <td class="tg-0lax">4.4</td>
    <td class="tg-0lax">2.0</td>
  </tr>
  <tr>
    <td class="tg-0lax">Amazon Pay</td>
    <td class="tg-0lax">Feb, 2019</td>
    <td class="tg-0lax">18.15.2</td>
    <td class="tg-0lax">-</td>
    <td class="tg-0lax">-</td>
    <td class="tg-0lax">2.0</td>
  </tr>
</tbody>
</table>

<p><br /></p>

<h2 id="about-upi">About UPI</h2>

<p>The Unified Payments Interface is a backend infrastructure that facilitates free and instant micropayments at scale from a mobile platform. Prior to UPI, Indian payment apps were predominantly wallet applications, where in a user deposited money to a wallet hosted by a service provider and the money transfer was carried out wallet-to-wallet. Besides payments via wallet apps, banks in India also provided Internet banking services with select ecommerce sites providing payments via internet banking. Figure below shows the differences between Internet banking and UPI-based banking.</p>

<div class="row">
    <div class="col-sm mt-2 mt-md-0">
        <img class="img-fluid rounded z-depth-1" src="/assets/img/internetbanking.png" alt="" title="internet banking" />
    </div>
    <div class="col-sm mt-2 mt-md-0">
        <img class="img-fluid rounded z-depth-1" src="/assets/img/upitransfer.png" alt="" title="upi transfer workflow" />
    </div>
</div>
<div class="caption">
    On the left is shown how traditional internet banking is carried out between Alice and Bob. Alice enter Bob's bank account number and IFSC code to transfer money. In UPI, Alice enters Bob's UPI ID, which in majority cases is a user's cell number. Internall, UPI maps the UPI ID to Bob's bank account number and IFSC code to initiate a bank-to-bank transfer. In case of payment apps, the transfer happens wallet to wallet. 
</div>

<h3 id="known-guidelines">Known Guidelines</h3>

<p>The National Payments Corporation of India has published a few “broad” guidelines for users of UPI. The UPI payment system requires Alice to register her primary cell number with her bank account(s) out-of-band to send or receive money. UPI uses the cell number (i) as a proxy for a user’s digital identity with the bank to look up a bank account given a cell number; (ii) as a factor in authentication via SMS one-time passcodes (OTP); and (iii) to alert users on transactions. To register for UPI services, Alice must set up her UPI user profile, add a bank account, and enable transactions on that bank account.</p>

<h4 id="setup-user-profile">Setup User profile</h4>
<p>To set up her UPI user profile, Alice must first create a profile with UPI via a UPI app installed on her bank-registered cell phone.</p>

<p><strong>Factor 1: Device fingerprint.</strong> Once a UPI app gets a user’s cell number, the app must send an outbound encrypted SMS from Alice’s phone to the UPI server. This process is automated and does not involve the user in order to guarantee a strong association between a user’s cell phone and her device. According to UPI, this is the “most critical security requirement” of the protocol since all money transactions from a user’s device are first verified based on this association. UPI calls this association of a user’s device with her cell number as device hard-binding. The combined cell number and device information (that represents this binding) is called the device fingerprint, which per the UPI spec is the first factor of authentication.</p>

<p><strong>Factor 2: Passcode.</strong> The UPI spec considers application passcode as optional and leaves it up to a UPI app vendor to authenticate the passcode. However, most apps make use of a passcode. For instance, BHIM uses a 4-digit passcode.</p>

<h4 id="add-bank-account">Add Bank Account</h4>
<p>A user’s request to add a bank must be from the device registered with UPI. Internally, UPI fetches the chosen bank’s account number and IFSC code based on a user’s cell number for later transactions through the UPI app.</p>

<h4 id="authorize-transactions">Authorize Transactions</h4>
<p>For Alice to be able to transact on an added bank account, she has to set up a UPI PIN for that account before the first transaction. The UPI PIN is Alice’s secret to authorize any future transactions. To set the UPI PIN, Alice must furnish information printed on the debit card— the last six digits of her bank’s ATM or debit card number and expiration date. Alice must also enter an OTP she receives from the UPI server. The UPI PIN is a highly sensitive factor since the UPI server uses it to prevent unauthorized transactions on Alice’s bank account.</p>

<p>Thus, the responsibility to completely authenticate a user is shared between two servers—the UPI server (that verifies device fingerprint and UPI PIN), and a payment app server (that verifies an app passcode).</p>

<h3 id="threat-model">Threat Model</h3>
<p>We assume a normal user, Alice, who installs payment apps from official sources such as Google Play. Alice has a properly configured phone with Internet facility and prevents physical access to it by untrusted parties. On the other hand, the attacker, Eve, uses a rooted phone. Eve can use any tool at her disposal to reverse engineer the payment apps. We assume that Eve releases an apparently useful unprivileged app called Mally that requests the following two permissions—android.permission.INTERNET and android.permission.RECEIVE_SMS. Alice finds the app useful and installs it, granting it the necessary permissions.</p>

<p>We consider our threat model to be realistic for the following reasons. First, according to the Android security review for the last two years, India is among the top three countries with the highest rate of potentially harmful applications such as trojans and backdoors, sometimes pre-installed on Android devices. Google has also recently released a warning stating that 53% of the major attacks are because of malicious apps that come pre-installed on low-cost smartphones.</p>

<h3 id="attack-example">Attack Example</h3>
<p>In the attack example, an attacker is able to compromise an existing user’s BHIM account on attacker’s phone.</p>
<blockquote>Unlike mobile wallets where money may only be lost from the wallet, here the attacker can empty an existing user’s, new user's, or non-UPI user's bank account.</blockquote>

<h4 id="attack-pre-conditions">Attack Pre-conditions</h4>
<p>Prior to the attack:</p>
<ol>
  <li>The attacker disables BHIM’s client-side defenses and installs repackaged version of BHIM.</li>
  <li>The victim’s device is already compromised with the attacker’s trojan app.</li>
  <li>The attacker learns of a user’s cell number. While the cell number is not a secret and is widely circulated in India, the attacker can get the cell number starting with no knowledge of a user.</li>
</ol>

<h4 id="attack-step-by-step">Attack Step-by-Step</h4>
<p>The goal of this attack is to compromise an existing UPI user’s bank account. If the attack succeeds, the attacker is able to sync an existing user’s bank account on an attacker-controlled devie. The attack starts with the attacker trying to set up BHIM as a new user on an attacker-controlled phone.</p>
<ul>
<li> Figure below shows UPI's default workflow, as we extract from BHIM.
1. BHIM app sends device details to the UPI server.
2. UPI server sends a registration token back to the client.
3. BHIM app sends an SMS containing the token.
4. The server extracts cell number from SMS, verifies token and confirms user's cell number (checks if new user or existing user).
5. Server confirms successful devie binding

<br />
<div class="row">
    <div class="col-sm mt-3 mt-md-0">
        <img class="img-fluid rounded z-depth-1" src="/assets/img/devicebinding.png" alt="" title="device binding workflow" />
    </div>
</div>
</li>

<li> From an attacker standpoint, Step 2 of the device hard-binding workflow is hard to compromise since to compromise the send SMS functionality, the attacker has to bypass protections provided by a user's cell phone company. 

<br />
<div class="row">
    <div class="col-sm mt-3 mt-md-0">
        <img class="img-fluid rounded z-depth-1" src="/assets/img/step2-2.png" alt="" title="step 2 of workflow" />
    </div>
</div>
</li>

<li> We found an alternate workflow that will allow an attacker to bind her cell phone with a cell number registered to bank account of another user. <b>An attacker can induce a failure in Step 2 of the protocol by turning on airplane mode.</b>

<blockquote>Alternate workflow may allow an attacker to bind her cell phone with a cell number registered to bank account of another user</blockquote>

<div class="row">
    <div class="col-sm mt-3 mt-md-0">
        <img class="img-fluid rounded z-depth-1" src="/assets/img/step2-1.png" alt="" title="step 2 of workflow" />
    </div>
</div>

</li>

<li><b>Breaking device-binding:</b> Once send SMS fails, BHIM provides attacker an option to enter a cell number. The attacker enters Alice's cell number.
<div class="row">
    <div class="col-sm mt-3 mt-md-0">
        <img class="img-fluid rounded z-depth-1" src="/assets/img/step3.png" alt="" title="step 3 of workflow" />
    </div>
</div>

<blockquote>To break device binding, attacker only needs a user's cell number and one OTP from that number</blockquote>
</li>

<li><b>Leak passcode:</b> Once the attacker's device is bound to Alice's cell number, attacker is prompted for Alice's passcode. The trojan app on Alice's device aids the attacker by stealing the passcode. The paper talks about different ways to do this. One approach is to draw an overlay screen on BHIM's passcode entry screen. The stolen password is sent to the attacker.
<br />
<div class="row">
    <div class="col-sm mt-3 mt-md-0">
        <img class="img-fluid rounded z-depth-1" src="/assets/img/step4.png" alt="" title="step 3 of workflow" />
    </div>
</div>

<blockquote>The attacker is never prompted for a bank-related secret at any point in the user registration workflow</blockquote>
</li>
<li><b>Add bank account:</b> Once the attacker's enters the password, the attacker is prompted to choose a bank account from a list of banks provided by UPI. Attacker can simply brute force through the banks. UPI server does not appear to prevent brute force attacks. Even without it, an attacker can simply start with the most popular banks.

<br />
<div class="row">
    <div class="col-sm mt-3 mt-md-0">
        <img class="img-fluid rounded z-depth-1" src="/assets/img/step5.png" alt="" title="step 3 of workflow" />
    </div>
</div>

<blockquote> For an existing user of UPI, the user's account is sync'ed on the attacker's phone. A new user or a non-user of UPI is equally at risk given that UPI switch is enabled by default on the server-side.</blockquote>
</li>

<li><b>UPI PIN</b> The UPI PIN required to authorize transactions can be leaked the same way as the passcode. That apart, setting the UPI PIN only requires a user's last six digits of debit card number. This is a lower bar in India given that online or in-store transactions requires the complete debit card number and the PIN. Debit cards are also frequently handed out in stores and restaurants at the time of payments.
<blockquote>Setting UPI PIN requires only partial debit card info and NO secret - a lower bar in India</blockquote>
</li>
</ul>

<h3 id="faq">FAQ</h3>
<ol>
  <li>
    <p>Is UPI 2.0 secure?
<br />UPI is an unpublished protocol and relies on security by obscurity in its design. While NPCI has addressed a core vulnerability, we believe that the protocol needs further security vetting. Other threat model have to be considered such as SIM card cloning, theft of phone etc.</p>
  </li>
  <li>
    <p>Do the attacks have to be synchronous?
<br />No, the attacker can carry out the attack at any time</p>
  </li>
  <li>
    <p>Were the vulnerabilities disclosed?
<br />All our vulnerabilities were responsibly disclosed via multiple channels. We withheld the publication for two years to ensure sufficinet time was given to address the issues we found.</p>
  </li>
  <li>
    <p>Is device-binding really required?
<br />Yes. Device binding makes the attacks harder to execeute. Without it, the UPI app is an open playground.</p>
  </li>
  <li>
    <p>UPI workflow leaks the bank account number of a user. Is that a security risk?
<br />Besides privacy implications, leaking the bank account here is a problem since it can be used to reset UPI PIN.</p>
  </li>
</ol>


  </article>

</div>

    </div>

    <!-- Footer -->

    
<footer class="fixed-bottom">
  <div class="container mt-0">
    &copy; Copyright 2021 Renuka  Kumar.
    Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a>.  Hosted by <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank">Unsplash</a>.

    
    
  </div>
</footer>



  </body>

  <!-- Bootsrap & MDB scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.4.4/umd/popper.min.js" integrity="sha512-eUQ9hGdLjBjY3F41CScH3UX+4JDSI9zXeroz7hJ+RteoCaY+GP/LDoM8AO+Pt+DRFw3nXqsjh9Zsts8hnYv8/A==" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha512-M5KW3ztuIICmVIhjSqXe01oV2bpe248gOxqmlcYrEzAvws7Pw3z6BK0iGbrwvdrUQUhi3eXgtxp5I8PDo9YfjQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js" integrity="sha512-Mug9KHKmroQFMLm93zGrjhibM2z2Obg9l6qFG2qKjXEXkMp/VDkI4uju9m4QKPjWSwQ6O2qzZEnJDEeCw0Blcw==" crossorigin="anonymous"></script>

  
<!-- Mansory & imagesLoaded -->
<script defer src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script defer src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
<script defer src="/assets/js/mansory.js" type="text/javascript"></script>


  


<!-- Medium Zoom JS -->
<script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
<script src="/assets/js/zoom.js"></script>


<!-- Load Common JS -->
<script src="/assets/js/common.js"></script>


</html>
